# حدود وقيود Telegram Bot API وأفضل الممارسات للامتثال والأداء

## ملخص تنفيذي
تعمل واجهة برمجة تطبيقات بوتات تيليجرام (Telegram Bot API) وفق نموذج خدماتية واضح يستند إلى دفع الأحداث عبر الويب هوك (Webhooks) أو جلبها عبر الاقتراع الطويل (Long Polling)، مع سياسات أمان وحدود تشغيلية متنوعة لضبط الاستهلاك ومنع الإساءة. الحدود الأكثر تأثيرًا على تصميم الأنظمة وتشغيلها في بيئات الإنتاج هي:

- حدود الرسائل: تُعرف حدود دنيا غير رسمية لكنها عملية، تشمل قرابة 30 رسالة في الثانية إجماليًا للبوت، و20 رسالة في الدقيقة لنفس المجموعة، مع توصية بتوزيع الإشعارات الجماعية على مدى 8–12 ساعة. عند الحاجة، تتيح ميزات البث المدفوع (Paid Broadcasts) معدلات تصل إلى 1000 رسالة في الثانية بشرط تمكينها عبر BotFather وأن يتوفر رصيد كافٍ (≈10,000 نجمة تيليجرام) ورسوم لكل رسالة تتجاوز الحد المجاني.[^2][^3][^1]
- Webhooks: قيود الاتصالات المتزامنة الافتراضية عند التوصيل عبر HTTPS تساوي 40 اتصالًا، ويمكن رفعها حتى 100 عبر setWebhook؛ أما خوادم Bot API المحلية فتدعم زيادات كبيرة تصل إلى 100,000 اتصال.[^1]
- التحديثات: تُخزن incoming updates على خوادم تيليجرام لمدة 24 ساعة كحد أقصى.[^1]
- البث المدفوع: خيار رسمي برفع الحد إلى 1000 رسالة/ثانية مع تكلفة لكل رسالة (0.1 نجمة) والرصيد اللازم والتفعيل عبر allow_paid_broadcast؛ وتُذكر قيمة أعلى كحالة حدية عند توفر شروط معينة.[^2][^3][^1]

القرارات المعمارية الفورية الموصى بها:
- استخدام Webhooks في الإنتاج، مع معالج تحديثات خفيف وموثوق، وضع قوائم انتظار للتعامل مع الأحمال، وضبط الاتصالات المتزامنة بما يلائم السعة.[^4][^1]
- تصميم نظام تحكم بالمعدل (Token Bucket أو Leaky Bucket) واعتماد backoff تراجعي أسي للأخطاء 429/500، واحترام رأس retry_after المرسل من الخادم.[^2][^6]
- تقليل عدد المكالمات عبر التخزين المؤقت وعمليات التجميع وتقليل الاستدعاءات المتكررة.[^5][^7]
- قياس أداء فعلي وإعادة ضبط البارامترات (عدد الاتصالات، حجم القوائم، حدود المعدل، سياسات إعادة المحاولة) وفق مقاييس حقيقية.

خارطة تنفيذ مختصرة:
- أسبوع 1–2: نقل البوت إلى Webhooks، تفعيل auto-retry، بناء لوحة مراقبة (429، الكمون، معدل الرسائل/ث)، وتخزين مؤقت للمكالمات“重料”.[^4][^6][^5]
- أسبوع 3–4: تحسين قواعد البيانات والتخزين المؤقت، تنفيذ قوائم انتظار للتعامل مع الأحمال، ضبط حدود المعدل لكل دردشة/منشئ، تجارب تحمّل وتعديل الإعدادات.[^7]

لتوضيح الصورة سريعًا، يقدّم الجدول التالي أهم الحدود المؤثرة:

جدول 1 — ملخص الحدود التشغيلية الرئيسية
| البند | القيمة/السياسة | الملاحظات العملية |
|---|---|---|
| إجمالي الرسائل | ≈30 رسالة/ثانية | حد غير رسمي؛ يُنصح بتوزيع الإشعارات على 8–12 ساعة لتجنب الفيضانات.[^3][^2] |
| نفس المجموعة | 20 رسالة/دقيقة | تضبط الرسائل والتعديلات ضمن هذا الحد لتقليل 429.[^2] |
| تعديل الرسائل | حتى 20 تعديل/دقيقة لكل مجموعة | استثناء يُذكر في مصادر المجتمع، قابل للتغيير.[^2] |
| Webhooks الاتصالات | 40 اتصالًا (افتراضي)، حتى 100 | عبر setWebhook؛ المحلية تدعم حتى 100,000.[^1] |
| التحديثات المخزنة | 24 ساعة | قبل أن تُستبعد من خوادم تيليجرام.[^1] |
| Paid Broadcasts | حتى 1000 رسالة/ثانية | يتطلب تمكين وتمويل ورسوم/رسالة عند التجاوز.[^2][^3][^1] |

هذه الحدود ليست غاية بذاتها، بل قيد تصميمي يفرض تعظيم الاستفادة من قدرات البوت مع خفض التعرض لأخطاء الفيض (429) والأخطاء الدورية (500). وكما يتبين، النجاح التشغيلي يتطلب تجزئة الحمل، والتحكم بالمعدل، والتعامل الذكي مع الأخطاء، وقياسات أداء دورية لتحديث الضبط.

## منهجية ومصادر
يعتمد هذا الدليل على الوثائق الرسمية لمنصة تيليجرام (Bot API، إدارة الأخطاء، شروط المطورين)، وعلى أدلة مكتبات معتمدة (مثل grammY) التي توضح حدود الفيض وآليات التعامل مع 429، إضافةً إلى مقالات متخصصة في الأداء والتوسع من مصادر مجتمعية موثوقة. جرى اعتماد المعلومات حين توفرت في مصادر رسمية أولًا، مع الإشارة الصريحة إلى كل ما هو استدلالي أو مستقى من المجتمع، وتجنّب البناء على ادعاءات غير موثقة.[^1][^2][^3][^4][^5][^6][^7][^8][^9][^10][^11][^12]

قيمة البيانات التي يقدّمها المجتمع لا تُغني عن الحذر المنهجي: فبعض الحدود ديناميكية وقد تتغير بمرور الزمن أو تختلف باختلاف حمولة النظام أو شروط الدفع المجاني/المدفوع. لذلك، يوصى بالتحقق المستمر من الوثائق الرسمية قبل تغييرات كبيرة في التصميم التشغيلي.

فجوات معلوماتية تستحق المتابعة:
- أرقام الحدود الدقيقة ديناميكية ولا تُنشر رسميًا لكل نقطة نهاية؛ تُذكر قيم تقريبية في مصادر المجتمع.[^2]
- حدود بعض العمليات (مثل forward/copy 1–100 معرف رسالة) ليست “حدود معدل” بقدر ما هي قيود بنائية، وقد تُفهم خطأ على أنها حدود معدل.[^1]
- تفاصيل الربط بين ميزات الدفع (مثل البث المدفوع) وحدود الأسعار الفعلية عند حمل عالٍ تتطلب مراجعة دورية.[^1][^2]

## نظرة شاملة على واجهة Bot API: آلية العمل وحدودها
آلية استقبال التحديثات في البوتات تقترن بطريقتين: الاقتراع الطويل (Long Polling) حيث يبقي البوت اتصالًا مفتوحًا لجلب التحديثات، والويب هوك (Webhooks) حيث تزود تيليجرام عنوان URL عام وتتلقى التحديثات فور وقوعها. لكل وضعٍ مميزات وعيوب تشغيلية، لكن الاستخدام الإنتاجي يميل إلى Webhooks بفضل كفاءته في استقبال الأحداث في الوقت شبه الفوري وتقليل الحمل الشبكي، مع اشتراط توفر نطاق عام وشهادة SSL.[^4][^10]

كما تعتمد تيليجرام حدًا افتراضيًا لعدد الاتصالات المتزامنة عند توصيل الويب هوك إلى 40 اتصالًا، مع إمكانية رفعها إلى 100 عبر setWebhook. في حال تشغيل خادم Bot API محلي، يمكن زيادة الاتصالات بشكل كبير يصل إلى 100,000. بالإضافة إلى ذلك، تحفظ التحديثات الواردة لمدة 24 ساعة، ما يتيح هامشًا للمناولة المتأخرة دون فقدان الأحداث.[^1]

لبناء تصور عملي للاختيارات، نعرض الجدول التالي:

جدول 2 — مقارنة عملية بين Long Polling وWebhooks
| الجانب | Long Polling | Webhooks |
|---|---|---|
| آلية العمل | جلب دوري مع إبقاء الاتصال مفتوحًا | دفع فوري من تيليجرام إلى خادم البوت |
| زمن الاستجابة | شبه فوري يعتمد على الفاصل | شبه فوري وأدنى تأخير عادةً |
| تعقيد النشر | بسيط؛ لا يتطلب نطاقًا أو SSL | يتطلب URL عام وشهادة SSL |
| كفاءة الموارد | أعلى استهلاكًا عند الحجم الكبير | أكثر كفاءة؛ يرسل فقط عند وقوع حدث |
| قابلية التوسع | يتحكم التطبيق بالسرعة | يحتاج ضبط الاتصالات وتوازي المعالجة |
| إدارة الأخطاء | أسهل في التحكم | حساس للمهلات وإعادة الإرسال |
| المخاطر | تأخير بفعل الفواصل | شروط سباق عند إنهاء الطلب مبكرًا |
| توصية الإنتاج | ملائم للتطوير والاختبار | مفضل للإنتاج مع قوائم انتظار |

أما تفاصيل اتصالات الويب هوك فتتضح في القيم التالية:

جدول 3 — اتصالات Webhooks المتزامنة
| العنصر | القيمة |
|---|---|
| الحد الافتراضي لـ max_connections | 40 |
| الحد الرسمي عبر setWebhook | 1–100 |
| خادم Bot API المحلي | حتى 100,000 |
| زمن الاحتفاظ بـ incoming updates | 24 ساعة |

اختيار الوضع المناسب ليس قرارًا تقنيًا فقط، بل قرار معماري ينعكس على زمن الاستجابة، وتكلفة التشغيل، وتعقيد الاعتمادية. في معظم الحالات العملية، يتفوّق Webhooks عندما يقترن بقوائم انتظار وخطة مراقبة فعالة.[^4][^1][^10]

### رسائل، تعديلات، عمليات نسخ/إعادة توجيه
تضع تيليجرام حدودًا دنيا عملية على الرسائل والتعديلات والعمليات البنائية ذات الصلة:

- نفس المجموعة: حتى 20 رسالة في الدقيقة للبوت الواحد، مع وجود استثناء يُذكر يصل إلى 20 تعديل رسالة في الدقيقة لكل مجموعة؛ هذا الأخير غير مذكور رسميًا ويُعامل كقيمة مرجعية غير ثابتة.[^2]
- عمليات نسخ/إعادة توجيه: حد بنائي يتراوح بين 1 و100 معرف رسالة لكل طلب.[^1]
- فيوض الرسائل: لا يُنصح بتجاوز ≈30 رسالة/ثانية كحد إجمالي تقريبي؛ وتُوصى الإشعارات الجماعية بالتوزيع عبر 8–12 ساعة.[^3][^2]

جدول 4 — ملخص حدود الرسائل والتعديلات
| العملية | الحد التقريبي | المصدر/ملاحظة |
|---|---|---|
| إرسال في نفس المجموعة | 20 رسالة/دقيقة | استرشادي لتقليل 429.[^2] |
| تعديل رسالة في مجموعة | حتى 20 تعديل/دقيقة | استثناء مجتمعي؛ قد يتغير.[^2] |
| إجمالي الرسائل | ≈30 رسالة/ثانية | لتقليل أخطاء الفيض.[^3] |
| نسخ/إعادة توجيه | 1–100 معرف رسالة | حد بنائي، ليس معدلًا.[^1] |
| إشعارات جماعية | توزيع على 8–12 ساعة | توصية عملية.[^3] |

الاعتداد بهذه الحدود يجعل الجدولة الزمنية جزءًا أساسيًا من التصميم: لا يكفي وضع ميزانية كلية على مستوى البوت، بل يجب احترام حدود كل دردشة ومجموعة على حدة، وإلا سيتزايد تعرض الأخطاء 429.

### ميزات البث المدفوع (Paid Broadcasts)
يوفر البث المدفوع آلية لرفع القيود حين تتطلب الحالة حملًا عاليًا، مع قيود مالية وتشغيلية:

- الحد النظري: حتى 1000 رسالة/ثانية عند التمكين والتمويل.[^2][^3][^1]
- التمكين عبر BotFather وتمكين allow_paid_broadcast في الطلبات.[^2]
- متطلبات الرصيد: ≈10,000 نجمة على الأقل، وتكلفة 0.1 نجمة لكل رسالة تتجاوز الحد المجاني.[^2][^1]
- قيود سياسات: يجب احترام شروط المطورين والامتثال للخصوصية والشفافية.[^12]

جدول 5 — حدود وإعدادات البث المدفوع
| البند | القيمة/السياسة |
|---|---|
| الحد الأعلى للمعدل | حتى 1000 رسالة/ثانية |
| التمكين | عبر BotFather + allow_paid_broadcast |
| الرصيد الأدنى | ≈10,000 نجمة |
| الرسوم | 0.1 نجمة/رسالة تتجاوز الحد المجاني |
| شرط الامتثال | الالتزام بشروط المطورين |

تُستخدم هذه الميزة عندما يكون زمن الاستجابة والاحتياج التشغيلي يقتضيان معدلات إرسال تفوق الحدود المجانية، بشرط قبول التكلفة والالتزام الصارم بالسياسات.[^1][^2][^12]

### حدود المحتوى والوسائط
تعتمد تيليجرام حدود حجم للملفات الوسائطية، وتختلف بحسب طريقة الرفع والنوع:

- Bot API السحابي: الصور عبر روابط حتى 5MB، باقي الوسائط حتى 20MB؛ عبر multipart: الصور 10MB، باقي الملفات 50MB؛ أنواع الوسائط الرئيسية (صوت، وثائق، انيميشن، فيديو، فيديو_notes) حتى 50MB.[^1]
- خادم Bot API المحلي: حدود رفع تصل إلى 2000MB، وبدون حد أقصى للتحميل من سحابي تيليجرام.[^1]
- قيود الرسائل والنصوص: النص 1–4096 حرفًا بعد تحليل الكيانات، التسميات 0–1024، أسئلة الاستطلاعات 1–300، إلخ.[^1]

جدول 6 — حدود أحجام الملفات والوسائط
| العنصر | سحابي (رابط) | سحابي (multipart) | محلي (خادم Bot API) |
|---|---|---|---|
| صور | حتى 5MB | حتى 10MB | حتى 2000MB |
| باقي الوسائط | حتى 20MB | حتى 50MB | حتى 2000MB |
| تحميل | حتى 20MB | — | بلا حد |
| أنواع الوسائط | حتى 50MB (صوت/وثائق/انيميشن/فيديو/فيديو_notes) | نفس الحدود | نفس الحدود |

من الناحية العملية، تتطلب الملفات الكبيرة تصميم قناة تحميل فعّالة، وإدارة موارد التخزين المؤقت، ومراعاة زمن الاستجابة النهائي للمستخدم.

## حدود المعدل (Rate Limits): المجموعات والإرسال والويب هوك
لا تعلن تيليجرام جداول حدود معدل دقيقة لكل نقطة نهاية، وتُعامل الحدود بوصفها متغيرات تعتمد على حمولة النظام وشروط التشغيل. تُعرف حدود عملية من مجتمع المطورين ومراجع المكتبات، ويجب التعامل معها كإرشادات لا كقيم مطلقة:

- إجمالي الرسائل: ≈30 رسالة/ثانية؛ تجاوزها يُعرّض البوت لأخطاء 429.[^3]
- نفس المجموعة: 20 رسالة/دقيقة.[^2]
- Webhooks: الاتصالات المتزامنة 40 (افتراضي)، حتى 100 (رسمي)، وحالات محلية تصل 100,000.[^1]
- تعديل الرسائل: حتى 20 تعديل/دقيقة لكل مجموعة (استثناء مجتمعي قابل للتغيير).[^2]

جدول 7 — ملخص حدود المعدل حسب النوع
| النوع | الحد التقريبي | ملاحظات |
|---|---|---|
| إجمالي الرسائل | ≈30 رسالة/ثانية | حد غير رسمي؛ توزيع الأحمال.[^3] |
| نفس المجموعة | 20 رسالة/دقيقة | يشمل الرسائل الأساسية.[^2] |
| تعديل رسالة | 20 تعديل/دقيقة | مجتمع؛ غير مذكور رسميًا.[^2] |
| Webhooks الاتصالات | 40 (افتراضي) إلى 100 | محلية: حتى 100,000.[^1] |

هذه الحدود تؤكد ضرورة اعتماد آليات تحكم بالمعدل على مستوى التطبيق، بدل افتراض ثبات المعدلات أو انتظامها. كما تدل على أن الويب هوك ليس مجرد قناة دفع، بل هو محور تزامن وتأمين يحتاج ضبطًا دقيقًا.

### التعامل مع الأخطاء 429 وretry_after
عند تجاوز الحدود، يُرجع الخادم خطأ 429 مع رأس retry_after يحدد مدة الانتظار قبل إعادة المحاولة. الممارسة الآمنة تتمثل في:

- احترام القيمة المرسلة في retry_after وعدم التجاوز.
- اعتماد backoff تراجعي أسي للأخطاء 500 وشبكة، مع حد أقصى للمدة الزمنية.
- تضمين حدود للمحوّلات ومحددات المعدل ضمن إطار grammY أو ما يعادلها في لغات/أطر أخرى.[^6][^2]

يوضح الجدول التالي سياسة معالجة الأخطاء عمليًا:

جدول 8 — سياسة معالجة 429
| نوع الخطأ | الإشارة/الكود | السلوك الموصى به |
|---|---|---|
| Flood | 429 + retry_after | انتظار المدة المحددة ثم إعادة المحاولة |
| Internal Server Error | 500+ | إعادة المحاولة مع backoff تراجعي أسي |
| Network Errors | HttpError | إعادة المحاولة مع backoff تراجعي أسي |
| Max Delay | — | حد أقصى للانتظار (تضبطه افتراضيًا 3s→1h) |

تساعد سياسات المعالجة على تقليل أثر الذروة وتحسين الاعتمادية دون إغراق الخادم بطلبات متكررة.[^6]

## أفضل الممارسات لتجنب القيود
تجنب القيود لا يعني فقط رفع الحدود، بل تقليل الحاجة إليها عبر هندسة مدروسة للحمولات والتزامن:

- التحكم بالمعدل داخل التطبيق: اعتماد Token Bucket أو Leaky Bucket، مع خطط مجدولة لتوزيع الرسائل عبر الزمن، وتحديد حصص لكل دردشة، وتجزئة المعالجة حسب الأولوية.[^2][^7]
- الربط والتزامن: استخدام قوائم انتظار مثل Redis/RabbitMQ/Kafka لتسوية الذروة، وضبط عدد الاتصالات المتزامنة في Webhooks بحسب السعة المتاحة.[^4][^1][^7]
- تقليل المكالمات: التخزين المؤقت لمعلومات غالية (مثل getChatAdministrators)، وتقليل الاستدعاءات المتكررة عبر سياسات TTL، واستخدام التجميع حيث يلزم.[^5][^7]
- الاستراتيجيات الزمنية: جدولة إشعارات مجمّعة على مدى ساعات، بدل دفعات مفاجئة، للالتزام بالمعدلات ومنع الفيضانات.[^3][^2]

جدول 9 — آليات التحكم بالمعدل
| الآلية | فكرة العمل | متى تُستخدم |
|---|---|---|
| Token Bucket | مصرح بها عدد من الرموز لكل فترة | لتوزيع رسائل بسرعة دون تجاوز الحد |
| Leaky Bucket | يصرف بمعدل ثابت | لتنعيم الذروة والحفاظ على معدل مستقر |
| Queues | فصل الاستلام عن المعالجة | لمعالجة أحمال غير متزامنة وتجنب السباقات |

جدول 10 — خريطة التخزين المؤقت
| الكائن/الاستدعاء | مدة البقاء (TTL) | ملاحظات |
|---|---|---|
| getChatAdministrators | 5–15 دقيقة | يقلل استدعاءات متكررة |
| Member counts | 1–5 دقائق | حسب تغير المجتمع |
| File links | حسب الاستخدام | تخزين روابط مؤقتة لتحسين زمن الاستجابة |
| Restriction data | 5–10 دقائق | لضبط قواعد الاستخدام |

تؤكد التجربة العملية أن التخزين المؤقت لا يخفض الكمون فحسب، بل يحد من احتكاك البوت بالحدود التشغيلية للواجهة، وبالتالي يقلل تكرار 429.[^5]

### تقليل المكالمات وتحسين الاستهلاك
يُوصى بإدارة التخزين المؤقت للكائنات ذات التكلفة العالية، والامتناع عن الاستدعاءات الزائدة، واستخدام الدُفعات حيثما أمكن. دمج هذه السياسات مع مراقبة داخلية للاستهلاك يحقق توازنًا بين الأداء والامتثال.[^5][^7]

جدول 11 — سياسات TTL المقترحة
| الكائن | TTL | المراجعة الدورية |
|---|---|---|
| Administrators | 10 دقائق | أسبوعيًا |
| Counts | 2–5 دقائق | شهريًا |
| File links | حسب الحجم | شهريًا |
| Restrictions | 10 دقائق | أسبوعيًا |

## استراتيجيات الامتثال
الامتثال في بيئة تيليجرام ليس إجراءً متأخرًا، بل جزء من التصميم من اللحظة الأولى:

- الالتزام بشروط منصة بوتات تيليجرام: حماية الخصوصية، الشفافية في جمع البيانات، وتمكين المستخدمين من التحكم في بياناتهم.[^12]
- الشفافية والخصوصية: نشر سياسة خصوصية واضحة للمستخدمين وتوضيح الغرض من البيانات.[^12]
- الاستخدام المسؤول للميزات المدفوعة: لا تستخدم البث المدفوع لتجاوز القيود بطرق تنتهك شروط الخدمة؛ ويجب احترام جميع القوانين واللوائح ذات الصلة بالولاية القضائية للمستخدمين.[^12]
- مواءمة المعالجة مع إعدادات الخصوصية: ضمان أن القيود المفروضة على الإرسال والوصول لا تتعارض مع سياسات المنصة أو توقعات المستخدمين.

جدول 12 — مصفوفة الامتثال
| الالتزام | إجراء عملي |
|---|---|
| الخصوصية | سياسة خصوصية واضحة وتحديثات دورية |
| الشفافية | توضيح الأغراض والحدود للمستخدمين |
| البيانات | تقليل جمع البيانات والاحتفاظ المؤقت |
| المراقبة | تسجيل آمن للحوادث وإشعار المستخدمين |
| المراجعة | تدقيق داخلي ربع سنوي للسياسات |

## تحسين الأداء
تظهر الفارق الحقيقي في زمن الاستجابة حين تُحسن القرارات المعمارية والبنية التحتية:

- موقع الاستضافة: خوادم تيليجرام قريبة من أمستردام، وكلما اقترب الخادم جغرافيًا انخفض زمن الاستجابة. مثال عملي: نقل الاستضافة من سان فرانسيسكو إلى أوروبا خفّض زمن الاستجابة من ~150ms إلى ~12ms.[^5]
- Webhooks في الإنتاج: يميل إلى تقديم زمن استجابة أفضل من Polling عند ضبط الاتصالات المتزامنة والقوائم، مع الحفاظ على كفاءة الموارد.[^4][^10]
- تحسين إدارة الملفات: استخدام CDN خارجي وتخزين الروابط المؤقتة يقلل زمن تحميل الملفات ويُحسّن تجربة المستخدم.[^5][^7]

جدول 13 — أزمنة الاستجابة التقريبية
| الموقع | زمن الاستجابة (تقريبي) |
|---|---|
| لندن | ~12ms |
| نيويورك | ~80ms |
| سنغافورة | ~150ms |
| سان فرانسيسكو | ~150ms |

جدول 14 — قرارات البنية التحتية
| القرار | النتيجة | التكلفة/الفائدة |
|---|---|---|
| نقل الاستضافة لأوروبا | تقليل الكمون ~10× | تكلفة نقل/تشغيل |
| استخدام Webhooks | استجابة أسرع وكفاءة أعلى | إعداد SSL/URL عام |
| CDN خارجي | تحميل ملفات أسرع | تكلفة CDN |
| التخزين المؤقت | تقليل مكالمات API | إدارة TTL/اتساق |

### إدارة الاتصالات والذروة
ضبط max_connections وتوازي المعالجة عبر قوائم انتظار يقلل مخاطر إعادة الإرسال وشروط السباق، خصوصًا عند انتهاء طلب الويب هوك قبل إتمام المعالجة. المنهج الموصى به: استقبال سريع، تسجيل، إدخال قائمة انتظار، معالجة لاحقة بإرسال النتائج عند اللزوم.[^1][^4]

جدول 15 — ضبط الاتصالات المتزامنة
| السياق | القيمة الموصى بها | المخاطر |
|---|---|---|
| سحابي افتراضي | 40 | ذروة قد تعيد الإرسال |
| سحابي مُحسّن | 80–100 | تجاوز السعة يؤدي لـ429 |
| محلي | وفق السعة (حتى 100,000) | مراقبة الموارد ضرورية |

## إدارة الأخطاء والاستثناءات
تعد مسببات الأخطاء في واجهات تيليجرام إشارات تشغيلية لا ينبغي تجاهلها. يجب بناء مصفوفة تصنيف مع إجراء تصحيحي واضح:

- 429 (Too Many Requests): يتضمّن رأس retry_after؛ يجب الانتظار ثم إعادة المحاولة ضمن حدود أقصى لتأخير الطلب.[^2][^6]
- 400/403/401: مشاكل طلب/خصوصية/مصادقة؛ تتطلب تصحيحًا مباشرًا أو إيقاف المحاولة.[^8][^9]
- 500+: أخطاء خادم؛ إعادة المحاولة مع backoff تراجعي أسي، وتصعيد إذا استمرت.[^2][^6]
- Migrate 303: إعادة توجيه إلى مركز بيانات آخر؛ يجب تكرار الطلب في المركز المحدد.[^8]

جدول 16 — مصفوفة الأخطاء
| الكود/النوع | المعنى | الإجراء الموصى به |
|---|---|---|
| 429 Flood | تجاوز الحد | احترام retry_after + إعادة المحاولة |
| 400 Bad Request | خطأ في الطلب | تصحيح الإدخال قبل إعادة المحاولة |
| 401 Unauthorized | مصادقة غير صالحة | إعادة التفويض/إيقاف المحاولات |
| 403 Forbidden | انتهاك خصوصية | مراجعة الأذونات/الوصول |
| 500 Internal | خطأ خادم | backoff أسي + تصعيد |
| 303 See_Other | توجيه مركز بيانات | إعادة الطلب في المركز المحدد |

### تصميم سياسة إعادة المحاولة (Retry/Backoff)
- بنود أساسية: عدد محاولات محدود، تأخير متزايد، حد أقصى للزمن، فصل إعادة المحاولة عن منطق الأعمال، ومقاييس لتقييم الأثر.[^6][^2]
- حالات خاصة: احترام retry_after في 429، وتجنب إعادة المحاولة الأعمى عند 400/403، واستخدام backoff للأخطاء 500 وشبكة.

جدول 17 — سياسة إعادة المحاولة
| نوع الخطأ | الاستراتيجية | حدود المحاولات | حد أقصى للانتظار |
|---|---|---|---|
| 429 | انتظار retry_after | وفق السياسة | حد أقصى للتأخير (قابل للضبط) |
| 500 | Backoff أسي | 3–5 | ~1 ساعة |
| Network | Backoff أسي | 3–5 | ~1 ساعة |
| 400/403 | لا تُعيد | — | — |

## خطة تنفيذ مرجعية (Playbook)
خطة تنفيذ مرجعية تجمع أفضل الممارسات:

1) نقل من Long Polling إلى Webhooks مع SSL، وضبط الاتصالات، وتقليل زمن المعالجات.
2) تفعيل auto-retry واحترام retry_after، وضبط backoff للأخطاء 500/شبكة.
3) بناء Token Bucket/Rate Limiter، وتحديد حصص لكل دردشة/منشئ.
4) التخزين المؤقت والـ batching، وتفعيل قائمة انتظار للتعامل مع الذروة.
5) مراقبة لوحة قيادة: معدل 429، زمن الاستجابة، الرسائل/ث، وإشعارات للمشرفين.[^4][^1][^6]

جدول 18 — قائمة تحقق تنفيذية
| العنصر | الحالة | الدليل | المالك | التاريخ |
|---|---|---|---|---|
| Webhooks + SSL | — | تقرير إعداد | DevOps | — |
| auto-retry | — | تهيئة الإضافة | Backend | — |
| Rate Limiter | — | إعدادات مكوّن | Backend | — |
| التخزين المؤقت | — | سياسات TTL | Backend | — |
| Queue | — | دليل نشر | DevOps | — |
| مراقبة | — | لوحات قياس | SRE | — |

جدول 19 — لوحة مراقبة KPIs
| KPI | الهدف | العتبة | التنبيه |
|---|---|---|---|
| معدل 429 | <1% من الطلبات | >3% | فوري |
| زمن الاستجابة (P95) | <300ms | >600ms | يومي |
| الرسائل/ث | ضمن الميزانية | >80% من الحد | أسبوعي |
| أخطاء 500 | <0.5% | >2% | فوري |

## ملاحق وقوائم مرجعية
- جداول الحدود التفصيلية:
  - اتصالات Webhooks: 40 (افتراضي) → حتى 100 (رسمي)؛ محلية حتى 100,000.[^1]
  - المحتوى والوسائط: سحابي (5–50MB بحسب النوع/الطريقة)، محلي حتى 2000MB.[^1]
- قاموس الأخطاء:
  - 429 (Flood) مع retry_after، 400/403/401، 500+، 303 (Migrate).[^2][^8][^9]
- روابط المجتمع للمتابعة:
  - مناقشة حدود المعدل وتجارب فعلية حول بعض النقاط (مثل sendMessage/editMessage).[^11]

## المراجع
[^1]: Telegram Bot API — الوثائق الرسمية. https://core.telegram.org/bots/api  
[^2]: grammY: Scaling Up IV: Flood Limits. https://grammy.dev/advanced/flood  
[^3]: StackOverflow: What is the limit of sending messages from a telegram bot. https://stackoverflow.com/questions/45905266/what-is-the-limit-of-sending-messages-from-a-telegram-bot  
[^4]: grammY Guide: Long Polling vs. Webhooks. https://grammy.dev/guide/deployment-types  
[^5]: DEV: Optimising Your Telegram Bot Response Times. https://dev.to/imthedeveloper/optimising-your-telegram-bot-response-times-1a64  
[^6]: grammY Plugin: auto-retry. https://grammy.dev/plugins/auto-retry  
[^7]: NextStruggle: How to Scale Your Telegram Bot for High Traffic. https://www.nextstruggle.com/how-to-scale-your-telegram-bot-for-high-traffic-best-practices-strategies/askdushyant/  
[^8]: Telegram API Errors — وثائق الأخطاء الرسمية. https://core.telegram.org/api/errors  
[^9]: StackOverflow: Telegram Bot API errors codes (Integrating Groups and Channels). https://stackoverflow.com/questions/34040277/telegram-bot-api-errors-codes-integrating-groups-and-channels  
[^10]: Neurotech Africa: Telegram webhook vs polling. https://blog.neurotech.africa/telegram-webhook-vs-polling/  
[^11]: GitHub tdlib Issue #3034: About telegram rate limit for sendMessage and editMessage. https://github.com/tdlib/td/issues/3034  
[^12]: Telegram Bot Platform Developer Terms of Service. https://telegram.org/tos/bot-developers